# Agents overview

## What lives in this repo
- `app/main.py` boots the FastAPI application and wires the scanning router (`app/api`).
- `app/services/` contains the scanning workers, SQLite persistence helpers, and Gemini client.
- `data/` stores the SQLite registry (`scans.sqlite`) used to rehydrate historical jobs.

## IP scanner agent (FastAPI)
- Endpoints (`app/api/routes.py`):
  - `POST /scan`: queue a standard scan for `ip_addresses` and/or `endpoints`; returns a token and status URL.
  - `POST /ai-agent`: identical scan pipeline but tags the job as `mode="ai"` for reporting.
  - `GET /scan/{token}`: poll job progress/results. Jobs persist to SQLite (`SCAN_DB_PATH`, default `data/scans.sqlite`) when finished.
- Scan pipeline (`app/services/scanner.py`):
  - Target normalization + DNS/IP resolution.
  - Geolocation/provider lookup via `http://ip-api.com`.
  - Port probing across a curated common-port list; availability is inferred from any open port.
  - Risk scoring generated by Gemini given full scan context, with deterministic fallback favoring management/database ports (`HIGH_RISK_PORTS`) and overall surface breadth.
- Schemas for all payloads/responses live in `app/schemas.py`.

## Gemini integration
- `GeminiClient` (`app/services/gemini_client.py`) builds prompts from scan context, handles API calls, and normalizes responses for `interpret_risk`.
- Configure AI support by setting `GEMINI_API_KEY` (and optionally `GEMINI_MODEL`) in your environment.

## Running locally
- Create `.env` (or export env vars) with `GEMINI_API_KEY` if you want AI summaries.
- Install deps: `pip install -r requirements.txt`.
- Start API: `uvicorn app.main:app --reload`.
- Quick manual test: run `python app/test.py` while the API is up; it will queue a scan and poll until complete.
